# 사용자 스토리 (User Stories)

## 목차
1. [Epic 1: 상품 탐색 및 선택](#epic-1-상품-탐색-및-선택)
2. [Epic 2: 장바구니 관리](#epic-2-장바구니-관리)
3. [Epic 3: 주문 및 결제](#epic-3-주문-및-결제)
4. [Epic 4: 쿠폰 관리](#epic-4-쿠폰-관리)
5. [Epic 5: 포인트 관리](#epic-5-포인트-관리)
6. [Epic 6: 주문 조회 및 취소](#epic-6-주문-조회-및-취소)

---

## Epic 1: 상품 탐색 및 선택

### US-001: 상품 카테고리 조회
**As a** 고객
**I want to** 판매 중인 상품 카테고리 목록을 보고 싶다
**So that** 다양한 차 종류를 확인하고 선택할 수 있다

#### 인수 기준 (Acceptance Criteria)
```gherkin
Given 서비스 홈페이지에 접속했을 때
When 상품 카테고리 목록 페이지를 요청하면
Then 허브티, 그린티, 블랙티, 화이트티, 루이보스 등의 카테고리가 표시된다
And 각 카테고리의 이름, 설명, 대표 이미지가 포함된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 홈페이지에 접속한다
2. 시스템은 활성화된 카테고리 목록을 조회한다
3. 카테고리 정보를 반환한다

**예외 시나리오**:
- 모든 카테고리가 비활성화된 경우: 빈 목록 반환
- DB 조회 실패: 500 에러, 재시도 유도

---

### US-002: 카테고리별 상품 조회
**As a** 고객
**I want to** 선택한 카테고리의 상품들을 보고 싶다
**So that** 원하는 차 제품을 선택할 수 있다

#### 인수 기준
```gherkin
Given 카테고리를 선택했을 때
When 해당 카테고리의 상품 목록을 요청하면
Then 카테고리에 속한 모든 상품이 표시된다
And 각 상품의 이름, 설명, 가격, 이미지가 포함된다
And 상품별 재고 상태가 표시된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 "허브티" 카테고리를 클릭한다
2. 시스템은 허브티 카테고리의 상품들을 조회한다
3. 상품 목록을 가격 순으로 정렬하여 반환한다

---

### US-003: 상품 재고 확인
**As a** 고객
**I want to** 원하는 상품의 재고가 얼마나 남았는지 알고 싶다
**So that** 품절되기 전에 빠르게 주문을 결정할 수 있다

#### 인수 기준
```gherkin
Given 상품을 선택했을 때
When 재고를 조회하면
Then 해당 상품의 현재 재고 수량이 실시간으로 표시된다
And "15개 남음" 형태로 표시된다
And 재고가 10개 이하면 "서둡러 주문하세요" 메시지가 표시된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 상품을 선택한다
2. 시스템은 DB에서 실시간 재고를 조회한다 (캐시 없음)
3. 재고 수량을 반환한다

**예외 시나리오**:
- 재고 0개: "품절" 표시, 장바구니 담기 불가

---

### US-004: 인기 상품 확인
**As a** 고객
**I want to** 다른 사람들이 많이 구매한 상품을 보고 싶다
**So that** 인기 있는 상품을 참고하여 선택할 수 있다

#### 인수 기준
```gherkin
Given 홈페이지에 접속했을 때
When "인기 상품 TOP 5" 섹션을 확인하면
Then 최근 7일간 가장 많이 주문된 상품 5개가 표시된다
And 각 상품의 판매량과 증감률이 표시된다
And 상품에 대한 간단한 설명이 표시된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 홈페이지를 방문한다
2. 시스템은 캐시된 인기 통계를 조회한다 (1시간 TTL)
3. 캐시가 없으면 DB에서 집계 쿼리를 실행한다
4. TOP 5 상품을 반환한다

---

## Epic 2: 장바구니 관리

### US-005: 장바구니에 상품 추가
**As a** 고객
**I want to** 선택한 상품을 수량과 함께 장바구니에 담고 싶다
**So that** 나중에 한 번에 주문할 수 있다

#### 인수 기준
```gherkin
Given 상품을 선택하고 수량을 입력했을 때
When "장바구니 담기" 버튼을 클릭하면
Then 장바구니에 해당 상품과 수량이 추가된다
And "장바구니에 추가되었습니다" 메시지가 표시된다
And 장바구니 아이콘에 총 상품 개수가 표시된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 "얼 그레이 티" 상품을 선택한다
2. 수량을 3개로 입력한다
3. "장바구니 담기" 버튼을 클릭한다
4. 시스템은 상품과 재고의 유효성을 검증한다
5. 장바구니에 항목을 추가한다
6. 성공 메시지를 반환한다

**예외 시나리오**:
- 존재하지 않는 상품: 404 에러
- 재고보다 많은 수량: 400 에러, "재고가 부족합니다"
- 장바구니 최대 10개 상품 초과: 400 에러

---

### US-006: 장바구니 조회
**As a** 고객
**I want to** 장바구니에 담긴 상품들을 보고 싶다
**So that** 주문 전에 확인하고 수정할 수 있다

#### 인수 기준
```gherkin
Given 장바구니에 상품이 있을 때
When 장바구니 페이지를 요청하면
Then 담긴 모든 상품 목록이 표시된다
And 각 상품의 이름, 수량, 단가, 소계, 재고 상태가 표시된다
And 총 상품 금액이 표시된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 장바구니 아이콘을 클릭한다
2. 시스템은 사용자의 장바구니 항목을 조회한다
3. 각 항목의 현재 재고 상태를 확인한다
4. 장바구니 정보를 반환한다

**예외 시나리오**:
- 빈 장바구니: "장바구니가 비어있습니다" 메시지
- 항목의 재고 부족: 빨간색으로 "재고 부족" 표시

---

### US-007: 장바구니 항목 수량 변경 및 삭제
**As a** 고객
**I want to** 장바구니에서 특정 상품의 수량을 변경하거나 삭제하고 싶다
**So that** 원하는 수량으로 조정하거나 불필요한 항목을 제거할 수 있다

#### 인수 기준
```gherkin
Given 장바구니에 여러 상품이 있을 때
When 특정 상품의 수량을 변경하면
Then 해당 상품의 수량과 소계가 업데이트된다
And 총 금액이 업데이트된다
When 특정 상품의 "삭제" 버튼을 클릭하면
Then 해당 상품이 장바구니에서 제거된다
And 총 금액이 업데이트된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 장바구니에서 수량을 5개로 변경한다
2. 시스템은 재고를 확인하고 수량을 업데이트한다
3. 소계와 총액을 다시 계산한다
4. 업데이트된 정보를 반환한다

---

### US-008: 여러 종류 상품 담기
**As a** 고객
**I want to** 나와 가족을 위해 다른 종류의 상품을 여러 개 담고 싶다
**So that** 한 번의 주문으로 여러 가지 차를 구매할 수 있다

#### 인수 기준
```gherkin
Given 장바구니에 이미 1개 상품이 있을 때
When 다른 종류의 상품을 추가하면
Then 장바구니에 2개 상품이 표시된다
And 각 상품은 서로 다른 종류이다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 "얼 그레이 티" 3개를 장바구니에 추가한다
2. 다시 상품 페이지로 돌아간다
3. "캐모마일 티" 2개를 선택한다
4. 장바구니에 추가한다
5. 장바구니에 2개 상품이 표시된다

---

## Epic 3: 주문 및 결제

### US-009: 주문 생성 및 결제
**As a** 고객
**I want to** 장바구니의 상품들을 주문하고 결제하고 싶다
**So that** 차 제품을 받아볼 수 있다

#### 인수 기준
```gherkin
Given 장바구니에 상품이 있고 포인트 잔액이 충분할 때
When "주문하기" 버튼을 클릭하면
Then 주문 확인 페이지가 표시된다
And 배송지를 입력할 수 있다
And 사용 가능한 쿠폰 목록이 표시된다
When "결제하기" 버튼을 클릭하면
Then 각 상품의 재고가 주문 수량만큼 차감된다
And 포인트가 차감된다
And 쿠폰이 사용 처리된다
And 주문이 생성된다
And 주문 완료 페이지로 이동한다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 장바구니에서 "주문하기" 버튼을 클릭한다
2. 주문 확인 페이지에서 배송지를 입력한다
3. 쿠폰을 선택한다 (선택사항)
4. "결제하기" 버튼을 클릭한다
5. 시스템은 트랜잭션을 시작한다
6. 재고를 확인하고 차감한다
7. 쿠폰 유효성을 검증하고 사용 처리한다
8. 포인트를 차감한다
9. 주문을 생성한다
10. Outbox에 외부 전송 이벤트를 저장한다
11. 트랜잭션을 커밋한다
12. 주문 완료 정보를 반환한다

**예외 시나리오 1 - 재고 부족**:
```gherkin
Given 장바구니에 상품이 있을 때
When 주문 처리 중 특정 상품의 재고가 부족하면
Then "재고가 부족하여 주문할 수 없습니다" 에러가 발생한다
And 트랜잭션이 롤백된다
And 사용자에게 에러 메시지가 표시된다
```

**예외 시나리오 2 - 포인트 부족**:
```gherkin
Given 포인트가 부족할 때
When 결제를 시도하면
Then "잔액이 부족합니다" 에러가 발생한다
And 재고가 복원된다
And 쿠폰이 복원된다
And 사용자에게 충전 페이지로 이동 유도
```

**예외 시나리오 3 - 쿠폰 무효**:
```gherkin
Given 만료된 쿠폰을 선택했을 때
When 결제를 시도하면
Then "유효하지 않은 쿠폰입니다" 에러가 발생한다
And 재고가 복원된다
```

**예외 시나리오 4 - 동시 주문으로 재고 소진**:
```gherkin
Given 특정 상품의 재고가 1개 남았을 때
When 2명이 동시에 해당 상품을 주문하면
Then 1명은 주문 성공
And 1명은 "재고가 소진되었습니다" 에러
And 해당 상품의 재고는 정확히 0개가 된다
```

---

### US-010: 쿠폰 할인 적용
**As a** 고객
**I want to** 보유한 쿠폰을 사용하여 할인받고 싶다
**So that** 더 저렴하게 구매할 수 있다

#### 인수 기준
```gherkin
Given 사용 가능한 쿠폰이 있을 때
When 주문 페이지에서 쿠폰을 선택하면
Then 할인 금액이 계산된다
And 최종 결제 금액이 업데이트된다
And 최소 주문 금액을 충족하지 못하면 적용 불가 메시지가 표시된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 주문 페이지에서 "쿠폰 선택" 버튼을 클릭한다
2. 보유한 사용 가능 쿠폰 목록이 표시된다
3. "첫구매 20% 할인" 쿠폰을 선택한다
4. 시스템은 최소 주문 금액(20,000원)을 확인한다
5. 할인 금액(4,000원)을 계산한다
6. 최종 금액(16,000원)을 표시한다

**예외 시나리오**:
- 최소 주문 금액 미달: "최소 주문 금액 20,000원 이상부터 사용 가능합니다"
- 이미 사용한 쿠폰: 목록에 표시되지 않음

---

## Epic 4: 쿠폰 관리

### US-011: 선착순 쿠폰 발급
**As a** 고객
**I want to** 한정 수량 쿠폰을 선착순으로 발급받고 싶다
**So that** 할인 혜택을 받을 수 있다

#### 인수 기준
```gherkin
Given 발급 가능한 쿠폰이 있을 때
When "쿠폰 받기" 버튼을 클릭하면
Then 쿠폰이 발급된다
And "쿠폰이 발급되었습니다" 메시지가 표시된다
And 남은 수량이 1개 감소한다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 이벤트 페이지에 접속한다
2. "첫구매 20% 할인 (선착순 100명)" 쿠폰을 확인한다
3. 남은 수량 23/100을 확인한다
4. "쿠폰 받기" 버튼을 클릭한다
5. 시스템은 Redis 분산 락을 획득한다
6. Redis Lua Script로 수량을 원자적으로 증가시킨다
7. DB에 중복 발급 체크 (user_id + coupon_id 유니크)
8. 사용자 쿠폰을 생성한다
9. 발급 이력을 기록한다
10. 성공 메시지를 반환한다

**예외 시나리오 1 - 쿠폰 소진**:
```gherkin
Given 쿠폰이 100/100 발급되었을 때
When 101번째 사용자가 발급 시도하면
Then "쿠폰이 모두 소진되었습니다" 에러가 발생한다
And HTTP 410 Gone 응답
```

**예외 시나리오 2 - 중복 발급**:
```gherkin
Given 이미 쿠폰을 발급받았을 때
When 다시 발급 시도하면
Then "이미 발급받은 쿠폰입니다" 에러가 발생한다
And HTTP 409 Conflict 응답
```

**예외 시나리오 3 - 동시 요청**:
```gherkin
Given 쿠폰 발급 처리 중일 때
When 동일 사용자가 다시 클릭하면
Then "잠시 후 다시 시도해주세요" 에러가 발생한다
And HTTP 429 Too Many Requests 응답
```

**예외 시나리오 4 - 동시 100명 발급**:
```gherkin
Given 쿠폰이 100개 남았을 때
When 200명이 동시에 발급 시도하면
Then 정확히 100명만 발급 성공
And 100명은 "쿠폰 소진" 에러
And Redis 카운터와 DB 발급 수가 일치한다
```

---

### US-012: 보유 쿠폰 조회
**As a** 고객
**I want to** 내가 가진 쿠폰을 확인하고 싶다
**So that** 사용 가능한 쿠폰을 파악할 수 있다

#### 인수 기준
```gherkin
Given 쿠폰을 발급받았을 때
When "내 쿠폰" 페이지를 요청하면
Then 보유한 모든 쿠폰이 표시된다
And 사용 가능, 사용완료, 만료됨 상태별로 구분된다
And 각 쿠폰의 할인 금액, 최소 주문 금액, 유효기간이 표시된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 "내 쿠폰" 메뉴를 클릭한다
2. 시스템은 사용자의 쿠폰 목록을 조회한다
3. 상태별로 필터링된 목록을 반환한다

---

## Epic 5: 포인트 관리

### US-013: 포인트 충전
**As a** 고객
**I want to** 포인트를 충전하고 싶다
**So that** 주문 시 결제할 수 있다

#### 인수 기준
```gherkin
Given 포인트 충전 페이지에 있을 때
When 충전 금액을 입력하고 "충전하기" 버튼을 클릭하면
Then 포인트가 충전된다
And 충전 내역이 기록된다
And 현재 잔액이 업데이트된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 "포인트 충전" 버튼을 클릭한다
2. 50,000원을 입력한다
3. "충전하기" 버튼을 클릭한다
4. 시스템은 사용자 잔액을 업데이트한다
5. 포인트 이력을 기록한다
6. 충전 완료 메시지를 반환한다

**예외 시나리오**:
- 0원 또는 음수 입력: "올바른 금액을 입력해주세요"
- 100원 단위 아님: "100원 단위로 입력해주세요"

---

### US-014: 포인트 내역 조회
**As a** 고객
**I want to** 포인트 충전 및 사용 내역을 보고 싶다
**So that** 포인트 사용을 추적할 수 있다

#### 인수 기준
```gherkin
Given 포인트 사용 이력이 있을 때
When "포인트 내역" 페이지를 요청하면
Then 충전, 사용, 환불 내역이 시간 순으로 표시된다
And 각 내역의 금액, 잔액, 설명이 표시된다
And 현재 보유 포인트가 표시된다
```

---

## Epic 6: 주문 조회 및 취소

### US-015: 주문 내역 조회
**As a** 고객
**I want to** 내가 주문한 이력을 보고 싶다
**So that** 주문 상태를 확인할 수 있다

#### 인수 기준
```gherkin
Given 주문한 이력이 있을 때
When "내 주문" 페이지를 요청하면
Then 주문 목록이 최신 순으로 표시된다
And 각 주문의 주문번호, 상태, 금액, 주문일이 표시된다
And 주문 상태별로 필터링할 수 있다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 "내 주문" 메뉴를 클릭한다
2. 시스템은 사용자의 주문 목록을 조회한다 (페이징)
3. 최신 순으로 정렬된 목록을 반환한다

---

### US-016: 주문 상세 조회
**As a** 고객
**I want to** 특정 주문의 상세 정보를 보고 싶다
**So that** 어떤 상품을 주문했는지 확인할 수 있다

#### 인수 기준
```gherkin
Given 주문 목록에서 특정 주문을 선택했을 때
When 주문 상세 페이지를 요청하면
Then 주문한 모든 상품 정보가 표시된다
And 각 상품의 이름, 수량, 단가, 소계가 표시된다
And 결제 정보 (총액, 할인, 최종 금액)가 표시된다
And 배송지 정보가 표시된다
And 주문 상태가 표시된다
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 주문 목록에서 주문을 클릭한다
2. 시스템은 주문 상세 정보를 조회한다
3. 주문 항목, 상품 정보, 결제 정보를 반환한다

---

### US-017: 주문 취소
**As a** 고객
**I want to** 잘못 주문한 경우 취소하고 싶다
**So that** 재고와 포인트를 돌려받을 수 있다

#### 인수 기준
```gherkin
Given 결제 완료 상태의 주문이 있을 때
When "주문 취소" 버튼을 클릭하면
Then 취소 사유를 입력할 수 있다
When 취소를 확인하면
Then 주문 상태가 "취소완료"로 변경된다
And 재고가 복원된다
And 포인트가 환불된다
And 쿠폰이 복원된다 (만료 전인 경우)
```

#### 시나리오
**정상 시나리오**:
1. 사용자가 주문 상세 페이지에서 "취소" 버튼을 클릭한다
2. 취소 사유를 "주문 실수"로 선택한다
3. "취소 확인" 버튼을 클릭한다
4. 시스템은 취소 가능 여부를 확인한다 (제조 시작 전)
5. 재고를 복원한다
6. 포인트를 환불한다
7. 쿠폰을 복원한다
8. 주문 상태를 "취소완료"로 변경한다
9. 성공 메시지를 반환한다

**예외 시나리오**:
```gherkin
Given 제조가 시작된 주문일 때
When 취소를 시도하면
Then "이미 제조가 시작되어 취소할 수 없습니다" 에러가 발생한다
```

---

## 백엔드 시스템 시나리오

### US-018: 외부 시스템 연동 (Outbox 처리)
**As a** 시스템
**I want to** 주문 정보를 배송업체에 전송하고 싶다
**So that** 배송업체가 상품을 포장하고 배송할 수 있다

#### 인수 기준
```gherkin
Given 주문이 생성되었을 때
When Outbox 스케줄러가 실행되면
Then 미전송 이벤트를 조회한다
And 배송업체 API에 주문 정보를 전송한다
When 전송이 성공하면
Then Outbox 상태를 "SENT"로 업데이트한다
When 전송이 실패하면
Then 재시도 카운트를 증가시킨다
And 최대 3회까지 재시도한다
When 3회 실패하면
Then 관리자에게 알림을 발송한다
```

#### 시나리오
**정상 시나리오**:
1. 주문이 생성되면 OrderCreated 이벤트가 Outbox에 저장된다
2. 10초마다 실행되는 스케줄러가 미전송 이벤트를 조회한다
3. 배송업체 API에 주문 정보를 전송한다
4. 200 OK 응답을 받으면 상태를 "SENT"로 업데이트한다

**재시도 시나리오**:
1. 배송업체 API가 500 에러를 반환한다
2. 상태를 "PENDING"으로 유지한다
3. 재시도 카운트를 1 증가시킨다
4. 다음 스케줄링 때 다시 시도한다
5. 3회 실패 시 "FAILED" 상태로 변경하고 알림을 발송한다

**격리 시나리오**:
```gherkin
Given 배송업체 API가 다운되었을 때
When 주문을 생성하면
Then 주문은 정상적으로 생성된다
And Outbox에 이벤트가 저장된다
And 배송업체 API 장애는 주문 생성에 영향을 주지 않는다
```

---

## 성능 테스트 시나리오

### US-019: 동시 주문 처리
**As a** 시스템
**I want to** 동시에 많은 주문이 들어와도 정상 처리하고 싶다
**So that** 고객에게 안정적인 서비스를 제공할 수 있다

#### 인수 기준
```gherkin
Given 재고가 10개 남았을 때
When 50명이 동시에 주문하면
Then 10명은 주문 성공
And 40명은 "재고 부족" 에러
And 재고는 정확히 0개가 된다
And 응답 시간은 평균 2초 이하이다
```

---

### US-020: 선착순 쿠폰 발급 스트레스 테스트
**As a** 시스템
**I want to** 많은 사용자가 동시에 쿠폰을 발급받아도 정확히 처리하고 싶다
**So that** 정확한 수량 제어를 보장할 수 있다

#### 인수 기준
```gherkin
Given 쿠폰이 100개일 때
When 1000명이 동시에 발급 시도하면
Then 정확히 100명만 발급 성공
And 900명은 "쿠폰 소진" 에러
And Redis 카운터가 100이다
And DB에 정확히 100건의 user_coupon이 생성된다
```

---

## 에러 처리 시나리오

### US-021: 네트워크 타임아웃
**As a** 시스템
**I want to** 네트워크 장애 시에도 안정적으로 처리하고 싶다
**So that** 데이터 정합성을 유지할 수 있다

#### 인수 기준
```gherkin
Given 외부 API 호출 중 타임아웃이 발생했을 때
Then 트랜잭션은 커밋된다 (주문은 성공)
And Outbox에 이벤트가 저장된다
And 스케줄러가 재시도한다
```

---

## 인수 테스트 체크리스트

### 필수 테스트
- [ ] 동시 100명이 같은 상품 주문 시 재고 정합성
- [ ] 선착순 쿠폰 1000명 동시 발급 시 정확히 100명만 성공
- [ ] 주문 생성 중 외부 API 장애 시 주문은 성공
- [ ] 결제 실패 시 재고/쿠폰 정상 복원
- [ ] 주문 취소 시 재고/포인트/쿠폰 모두 복원
- [ ] 장바구니 최대 10개 상품 제한
- [ ] 1인 1매 쿠폰 중복 발급 방지
- [ ] 만료된 쿠폰 사용 불가
- [ ] 최소 주문 금액 미달 시 쿠폰 사용 불가
- [ ] 포인트 음수 방지

### 성능 테스트
- [ ] 상품 조회 평균 100ms 이하
- [ ] 주문 처리 평균 2초 이하
- [ ] 동시 주문 초당 100건 처리

---

## 변경 이력
| 버전 | 날짜 | 변경 내용 | 작성자 |
|-----|------|----------|-----|
| 1.0 | 2025-10-31 | 초안 작성 | jay  |