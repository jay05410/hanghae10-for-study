spring:
  application:
    name: ecommerce

  jackson:
    time-zone: Asia/Seoul

  # MySQL
  datasource:
    url: jdbc:p6spy:mysql://localhost:3306/ecommerce
    driver-class-name: com.p6spy.engine.spy.P6SpyDriver
    username: admin
    password: admin123

  # Redis
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
      timeout: 3000ms

  h2:
    console:
      enabled: false

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        # SQL 로깅 비활성화 (p6spy에서 담당)
        show_sql: false
        format_sql: false
        use_sql_comments: false
        # Hibernate Statistics 비활성화
        generate_statistics: false
        jdbc:
          time_zone: Asia/Seoul
          batch_size: 20
        order_inserts: true
        order_updates: true
    database-platform: org.hibernate.dialect.MySQLDialect

  output:
    ansi:
      enabled: always

# 로깅 설정
logging:
  level:
    root: INFO
    io.hhplus.ecommerce: DEBUG
    org.springframework: INFO
    org.springframework.security: INFO
    # Hibernate 로깅 비활성화 (p6spy에서 담당)
    org.hibernate.SQL: OFF
    org.hibernate.type.descriptor.sql: OFF
    # p6spy 로그 레벨 설정
    p6spy: INFO

# 서버 설정
server:
  port: 8080

# Swagger 설정
springdoc:
  api-docs:
    enabled: true  # false로 변경하면 Swagger 완전 비활성화
  swagger-ui:
    enabled: true  # false로 변경하면 Swagger UI 비활성화
    path: /swagger-ui.html
  show-actuator: false

# Swagger 커스터마이징 설정
swagger:
  title: HH Plus E-Commerce API
  description: HH Plus E-Commerce Platform API Documentation
  version: 1.0.0
  auto-wrap-response: true  # false로 변경하면 ApiResponse 자동 래핑 비활성화


# 데이터 플랫폼 설정 (mockAPI.io)
dataplatform:
  enabled: ${DATAPLATFORM_ENABLED:true}
  url: ${DATAPLATFORM_URL:https://693adba99b80ba7262cbac6f.mockapi.io/api/v1/orders}

# Kafka 설정
kafka:
  enabled: ${KAFKA_ENABLED:true}
  bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
  consumer:
    group-id: ecommerce-consumer-group
    auto-offset-reset: earliest
  producer:
    acks: all
    retries: 3
  topics:
    order: ecommerce.order
    payment: ecommerce.payment
    coupon: ecommerce.coupon
    inventory: ecommerce.inventory
    data-platform: ecommerce.data-platform

# Spring Actuator 모니터링 설정
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,hikaricp,caches  # 노출할 엔드포인트
      base-path: /actuator  # Actuator 엔드포인트 기본 경로
  endpoint:
    health:
      show-details: always  # 헬스 체크 상세 정보 표시
      show-components: always
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true  # HTTP 요청 히스토그램
        cache.gets: true  # 캐시 조회 히스토그램
        cache.puts: true  # 캐시 저장 히스토그램
      percentiles:
        http.server.requests: 0.5, 0.95, 0.99  # HTTP 요청 백분위수
        cache.gets: 0.5, 0.95, 0.99  # 캐시 조회 백분위수
    tags:
      application: ${spring.application.name}
      cache-enabled: "true"  # 캐시 활성화 표시
    cache:
      metric-names:
        evictions: cache.evictions
        gets: cache.gets
        puts: cache.puts
        size: cache.size

# Resilience4j 설정
resilience4j:
  # Retry 설정
  retry:
    instances:
      dataPlatform:
        maxAttempts: 3                    # 최대 재시도 횟수
        waitDuration: 1s                  # 재시도 간격
        exponentialBackoffMultiplier: 2   # 지수 백오프 배수 (1s → 2s → 4s)
        retryExceptions:
          - java.io.IOException
          - java.net.SocketTimeoutException
          - org.springframework.web.client.ResourceAccessException
        ignoreExceptions:
          - io.hhplus.ecommerce.common.exception.BusinessException

  # Circuit Breaker 설정
  circuitbreaker:
    instances:
      dataPlatform:
        registerHealthIndicator: true     # Actuator에 상태 노출
        slidingWindowType: COUNT_BASED    # 카운트 기반 슬라이딩 윈도우
        slidingWindowSize: 10             # 최근 10개 요청 기준
        minimumNumberOfCalls: 5           # 최소 5개 요청 후 판단
        failureRateThreshold: 50          # 실패율 50% 이상 시 Open
        slowCallRateThreshold: 80         # 느린 호출 80% 이상 시 Open
        slowCallDurationThreshold: 3s     # 3초 이상이면 느린 호출
        waitDurationInOpenState: 30s      # Open 상태 유지 시간
        permittedNumberOfCallsInHalfOpenState: 3  # Half-Open에서 허용 호출 수
        automaticTransitionFromOpenToHalfOpenEnabled: true

