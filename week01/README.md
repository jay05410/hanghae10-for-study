# ν¬μΈνΈ κ΄€λ¦¬ μ‹μ¤ν…

TDD λ°©λ²•λ΅ μΌλ΅ κµ¬ν„ν• ν¬μΈνΈ μ¶©μ „/μ‚¬μ© μ‹μ¤ν…μ…λ‹λ‹¤.

## π“‹ μ£Όμ” κΈ°λ¥
- β… ν¬μΈνΈ μ΅°ν
- β… ν¬μΈνΈ μ¶©μ „
- β… ν¬μΈνΈ μ‚¬μ©
- β… ν¬μΈνΈ λ‚΄μ—­ μ΅°ν
- β… λ™μ‹μ„± μ μ–΄

## π—οΈ μ•„ν‚¤ν…μ²

### ν¨ν‚¤μ§€ κµ¬μ΅°
```
io.hhplus.tdd
β”β”€β”€ point/
β”‚   β”β”€β”€ PointController.kt          # REST API μ—”λ“ν¬μΈνΈ
β”‚   β”β”€β”€ service/
β”‚   β”‚   β”β”€β”€ PointQueryService.kt    # μ΅°ν μ„λΉ„μ¤
β”‚   β”‚   β”β”€β”€ PointChargeService.kt   # μ¶©μ „ μ„λΉ„μ¤
β”‚   β”‚   β”β”€β”€ PointUseService.kt      # μ‚¬μ© μ„λΉ„μ¤
β”‚   β”‚   β”β”€β”€ UserLockManager.kt      # λ™μ‹μ„± μ μ–΄
β”‚   β”‚   β””β”€β”€ PointTransactionLogger.kt # λ‚΄μ—­ κΈ°λ΅
β”‚   β”β”€β”€ vo/                         # Value Objects
β”‚   β”β”€β”€ validator/                  # κ²€μ¦ λ΅μ§
β”‚   β””β”€β”€ extension/                  # ν™•μ¥ ν•¨μ
β”β”€β”€ database/                       # μΈλ©”λ¨λ¦¬ DB
β””β”€β”€ common/                         # κ³µν†µ λ¨λ“
```

### μ£Όμ” μ„¤κ³„ μ›μΉ™
- **λ‹¨μΌ μ±…μ„ μ›μΉ™**: κ° μ„λΉ„μ¤λ” ν•λ‚μ μ±…μ„λ§ κ°€μ§
- **μμ΅΄μ„± μ£Όμ…**: Springμ DI μ»¨ν…μ΄λ„ ν™μ©
- **Value Object ν¨ν„΄**: λ„λ©”μΈ λ΅μ§ μΊ΅μν™”
- **μ±…μ„ λ¶„λ¦¬**: λ‚΄μ—­ κΈ°λ΅μ„ λ³„λ„ μ»΄ν¬λ„νΈλ΅ λ¶„λ¦¬

## π§ ν…μ¤νΈ μ „λµ

### ν…μ¤νΈ κµ¬μ΅°
```
src/test/kotlin/io/hhplus/tdd/point/
β”β”€β”€ service/                        # λ‹¨μ„ ν…μ¤νΈ
β”‚   β”β”€β”€ PointChargeServiceTest.kt   # μ¶©μ „ μ„λΉ„μ¤ λ‹¨μ„ ν…μ¤νΈ
β”‚   β”β”€β”€ PointUseServiceTest.kt      # μ‚¬μ© μ„λΉ„μ¤ λ‹¨μ„ ν…μ¤νΈ
β”‚   β””β”€β”€ PointQueryServiceTest.kt    # μ΅°ν μ„λΉ„μ¤ λ‹¨μ„ ν…μ¤νΈ
β”β”€β”€ PointIntegrationTest.kt         # ν†µν•© ν…μ¤νΈ
β””β”€β”€ PointConcurrencyIntegrationTest.kt # λ™μ‹μ„± ν†µν•© ν…μ¤νΈ
```

### ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€
- **μ΄ 24κ° ν…μ¤νΈ** λ¨λ‘ ν†µκ³Ό
- **λ‹¨μ„ ν…μ¤νΈ**: 12κ° (Mock κΈ°λ°)
- **ν†µν•© ν…μ¤νΈ**: 7κ° (μ „μ²΄ ν”λ΅μ°)
- **λ™μ‹μ„± ν…μ¤νΈ**: 5κ° (λ©€ν‹°μ¤λ λ“)

## β΅ λ™μ‹μ„± μ μ–΄ λ¶„μ„ λ³΄κ³ μ„

### 1. λ¬Έμ  μ •μ

#### λ™μ‹μ„± λ¬Έμ  μ‹λ‚λ¦¬μ¤
```
μ‚¬μ©μA: 10,000μ› β†’ +5,000μ› μ¶©μ „
μ‚¬μ©μB: 10,000μ› β†’ +3,000μ› μ¶©μ „ (λ™μ‹ μ‹¤ν–‰)

Thread1: selectById() β†’ 10,000μ›
Thread2: selectById() β†’ 10,000μ› (κ°™μ€ κ°’!)
Thread1: newPoint = 15,000μ›
Thread2: newPoint = 13,000μ›
Thread1: insertOrUpdate(15,000μ›)
Thread2: insertOrUpdate(13,000μ›) β† λ§μ§€λ§‰ μ“°κΈ°κ°€ μΉλ¦¬! 5,000μ› μ†μ‹¤!
```

#### λ°μƒ κ°€λ¥ν• λ¬Έμ 
- **Race Condition**: λ™μ‹ μ½κΈ°-μ“°κΈ°λ΅ μΈν• λ°μ΄ν„° μ†μ‹¤
- **Lost Update**: λ‚μ¤‘μ— μν–‰λ μ‘μ—…μ΄ μ΄μ „ μ‘μ—…μ„ λ®μ–΄μ”€
- **Inconsistent Data**: ν¬μΈνΈμ™€ λ‚΄μ—­ κ°„ λ¶μΌμΉ

### 2. ν•΄κ²° λ°©μ• λΉ„κµ λ¶„μ„

| λ°©μ‹ | μ¥μ  | λ‹¨μ  | μ μ© μ‹λ‚λ¦¬μ¤ |
|------|------|------|---------------|
| **μ‚¬μ©μλ³„ λ½** β­ | β€Ά λ†’μ€ λ™μ‹μ„±<br>β€Ά λ°λ“λ½ λ°©μ§€<br>β€Ά ν™•μ¥μ„± μΆ‹μ | β€Ά λ©”λ¨λ¦¬ μ‚¬μ©λ‰<br>β€Ά κµ¬ν„ λ³µμ΅λ„ | **μ„ νƒλ λ°©μ‹**<br>μ‚¬μ©μλ³„ λ…λ¦½μ  μ²λ¦¬ |
| **μ „μ—­ λ½** | β€Ά κµ¬ν„ κ°„λ‹¨<br>β€Ά ν™•μ‹¤ν• λ³΄μ¥ | β€Ά μ„±λ¥ λ³‘λ©<br>β€Ά ν™•μ¥μ„± λ‚μ¨ | λ‹¨μν• μ‹μ¤ν… |
| **λ‚™κ΄€μ  λ½** | β€Ά λ†’μ€ λ™μ‹μ„±<br>β€Ά μ¶©λ μ‹μ—λ§ μ¬μ‹λ„ | β€Ά μ¬μ‹λ„ λ΅μ§ ν•„μ”<br>β€Ά λ²„μ „ κ΄€λ¦¬ | μ¶©λμ΄ μ μ€ ν™κ²½ |
| **λΉ„κ΄€μ  λ½** | β€Ά ν™•μ‹¤ν• λ³΄μ¥<br>β€Ά λ΅μ§ λ‹¨μ | β€Ά μ„±λ¥ μ €ν•<br>β€Ά λ°λ“λ½ μ„ν— | μ¶©λμ΄ λ§μ€ ν™κ²½ |

### 3. κµ¬ν„λ λ™μ‹μ„± μ μ–΄

#### UserLockManager μ„¤κ³„
```kotlin
@Component
class UserLockManager {
    private val userLocks = ConcurrentHashMap<Long, ReentrantLock>()

    fun <T> executeWithLock(userId: Long, action: () -> T): T {
        val lock = getLock(userId)
        lock.lock()
        try {
            return action()
        } finally {
            lock.unlock()
        }
    }
}
```

#### ν•µμ‹¬ νΉμ§•
- **μ‚¬μ©μλ³„ λ…λ¦½ λ½**: λ‹¤λ¥Έ μ‚¬μ©μ κ°„ λΈ”λ΅ν‚Ή μ—†μ
- **ConcurrentHashMap**: Thread-Safeν• λ½ μ €μ¥μ†
- **ReentrantLock**: μ¬μ§„μ… κ°€λ¥ν• λ½
- **Template Method**: μΌκ΄€λ λ½ κ΄€λ¦¬

### 4. λ™μ‹μ„± ν…μ¤νΈ κ²€μ¦

#### ν…μ¤νΈ μ‹λ‚λ¦¬μ¤ λ° κ²°κ³Ό

**1) λ€λ‰ λ™μ‹ μ¶©μ „ ν…μ¤νΈ**
```kotlin
// 100κ° μ¤λ λ“κ°€ λ™μ‹μ— 1,000μ›μ”© μ¶©μ „
val futures = (1..100).map {
    CompletableFuture.supplyAsync {
        chargeService.charge(userId, 1000L)
    }
}
```
- **κ²°κ³Ό**: μ •ν™•ν 100,000μ› β…
- **λ‚΄μ—­**: 100κ±΄ λ¨λ‘ κΈ°λ΅ β…

**2) μ‚¬μ©μλ³„ λ…λ¦½μ„± ν…μ¤νΈ**
```kotlin
// μ‚¬μ©μ1: 50λ² μ¶©μ „, μ‚¬μ©μ2: 30λ² μ¶©μ „ λ™μ‹ μ‹¤ν–‰
```
- **κ²°κ³Ό**: μ‚¬μ©μ1=50,000μ›, μ‚¬μ©μ2=30,000μ› β…
- **λ…λ¦½μ„±**: μ‚¬μ©μ κ°„ κ°„μ„­ μ—†μ β…

**3) μ¶©μ „/μ‚¬μ© νΌν•© ν…μ¤νΈ**
```kotlin
// 30κ° μ¶©μ „(+1000μ›) + 20κ° μ‚¬μ©(-500μ›) λ™μ‹ μ‹¤ν–‰
```
- **κ²°κ³Ό**: 50,000 + 30,000 - 10,000 = 70,000μ› β…
- **μ •ν™•μ„±**: λ¨λ“  μ—°μ‚° μ •ν™•ν λ°μ β…

### 5. μ„±λ¥ λ¶„μ„

#### μ²λ¦¬λ‰ μΈ΅μ •
- **λ™μ‹ μ”μ²­**: 100κ° μ¤λ λ“
- **ν‰κ·  μ²λ¦¬ μ‹κ°„**: ~200ms (DB μ§€μ—° ν¬ν•¨)
- **μ„±κ³µλ¥ **: 100% (λ°μ΄ν„° μ†μ‹¤ μ—†μ)

#### ν™•μ¥μ„± κ³ λ ¤μ‚¬ν•­
- **λ©”λ¨λ¦¬ μ‚¬μ©**: μ‚¬μ©μλ‹Ή ν•λ‚μ λ½ κ°μ²΄
- **κ°€λΉ„μ§€ μ»¬λ ‰μ…**: μ¤λλ λ½ μ •λ¦¬ λ©”μ»¤λ‹μ¦ κ³ λ ¤ ν•„μ”
- **λ¶„μ‚° ν™κ²½**: Redis κΈ°λ° λ¶„μ‚° λ½μΌλ΅ ν™•μ¥ κ°€λ¥

### 6. κ²°λ΅  λ° κ°μ„  λ°©ν–¥

#### ν„μ¬ κµ¬ν„μ μ¥μ 
β… **μ •ν™•μ„±**: λ¨λ“  λ™μ‹μ„± ν…μ¤νΈ ν†µκ³Ό
β… **μ„±λ¥**: μ‚¬μ©μλ³„ λ…λ¦½μ  μ²λ¦¬λ΅ λ†’μ€ λ™μ‹μ„±
β… **ν™•μ¥μ„±**: μƒλ΅μ΄ μ‚¬μ©μ μ¶”κ°€ μ‹ μλ™ λ½ μƒμ„±
β… **μ•μ •μ„±**: λ°λ“λ½ μ„ν— μµμ†ν™”

#### ν–¥ν›„ κ°μ„  λ°©μ•
- **λ½ λ©”λ¨λ¦¬ κ΄€λ¦¬**: LRU κΈ°λ° λ½ μ •λ¦¬ λ©”μ»¤λ‹μ¦
- **λ¶„μ‚° λ½**: Redis/Zookeeper κΈ°λ° λ¶„μ‚° ν™κ²½ μ§€μ›
- **λ¨λ‹ν„°λ§**: λ½ κ²½ν•© μƒν™© λ¨λ‹ν„°λ§ λ° μ•λ¦Ό
- **μ„±λ¥ μµμ ν™”**: λ½ λ²”μ„ μµμ†ν™” λ° λΉ„λ™κΈ° μ²λ¦¬

## π€ μ‹¤ν–‰ λ°©λ²•

### μ• ν”λ¦¬μΌ€μ΄μ… μ‹¤ν–‰
```bash
./gradlew bootRun
```

### ν…μ¤νΈ μ‹¤ν–‰
```bash
# μ „μ²΄ ν…μ¤νΈ
./gradlew test

# λ‹¨μ„ ν…μ¤νΈλ§
./gradlew test --tests "*Service*Test"

# ν†µν•© ν…μ¤νΈλ§
./gradlew test --tests "*Integration*Test"

# λ™μ‹μ„± ν…μ¤νΈλ§
./gradlew test --tests "*Concurrency*Test"
```

### API μ—”λ“ν¬μΈνΈ

| λ©”μ„λ“ | κ²½λ΅ | μ„¤λ… |
|--------|------|------|
| GET | `/point/{id}` | ν¬μΈνΈ μ΅°ν |
| GET | `/point/{id}/histories` | λ‚΄μ—­ μ΅°ν |
| PATCH | `/point/{id}/charge` | ν¬μΈνΈ μ¶©μ „ |
| PATCH | `/point/{id}/use` | ν¬μΈνΈ μ‚¬μ© |

## π“ λΉ„μ¦λ‹μ¤ μ •μ±…

### μ¶©μ „ μ •μ±…
- **μµμ† κΈμ•΅**: 1,000μ›
- **μµλ€ κΈμ•΅**: 1,000,000μ›
- **μ¶©μ „ λ‹¨μ„**: 100μ› λ‹¨μ„

### μ‚¬μ© μ •μ±…
- **μµμ† κΈμ•΅**: 100μ›
- **μ‚¬μ© λ‹¨μ„**: 100μ› λ‹¨μ„
- **μΌμΌ ν•λ„**: 100,000μ›
- **μ”κ³  κ²€μ¦**: μ‚¬μ© κΈμ•΅ β‰¤ ν„μ¬ μ”κ³ 

### λ‚΄μ—­ μ •μ±…
- **μ •λ ¬**: μµμ‹ μ (timeMillis λ‚΄λ¦Όμ°¨μ)
- **μµλ€ μ΅°ν**: 100κ±΄
- **νƒ€μ…**: CHARGE, USE

## π› οΈ κΈ°μ  μ¤νƒ

- **μ–Έμ–΄**: Kotlin 1.9.21
- **ν”„λ μ„μ›ν¬**: Spring Boot 3.2.0
- **ν…μ¤νΈ**: Kotest 5.8.0
- **λ¨ν‚Ή**: MockK 1.13.8
- **λΉλ“**: Gradle 8.5
- **JDK**: OpenJDK 21

## π“ κ°λ° κ³Όμ •

μ΄ ν”„λ΅μ νΈλ” **TDD(Test-Driven Development)** λ°©λ²•λ΅ μ„ λ”°λΌ κ°λ°λμ—μµλ‹λ‹¤:

1. **Red**: μ‹¤ν¨ν•λ” ν…μ¤νΈ μ‘μ„±
2. **Green**: ν…μ¤νΈλ¥Ό ν†µκ³Όν•λ” μµμ† μ½”λ“ κµ¬ν„
3. **Refactor**: μ½”λ“ ν’μ§ κ°μ„  λ° λ¦¬ν©ν† λ§

### μ£Όμ” λ¦¬ν©ν† λ§ λ‚΄μ©
- μ±…μ„ λ¶„λ¦¬: `PointTransactionLogger` μ¶”μ¶
- λ™μ‹μ„± μ μ–΄: `UserLockManager` λ„μ…
- ν…μ¤νΈ κµ¬μ΅°: λ‹¨μ„/ν†µν•©/λ™μ‹μ„± ν…μ¤νΈ λ¶„λ¦¬